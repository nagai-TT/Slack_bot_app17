<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OPE Slack連携</title>
<style>
  body { font-family: sans-serif; background-color: #f5f5f5; margin: 0; height: 100vh; display: flex; justify-content: center; align-items: center; }
  .container { width: 100%; max-width: 600px; padding: 1rem; text-align: center; }
  h1 { margin-bottom: 1rem; }
  .hidden { display: none; }
  button, select { display: block; width: 80%; margin: 0.5rem auto; padding: 1rem; font-size: 1rem; background-color: #0077cc; color: white; border: none; border-radius: 10px; cursor: pointer; transition: background-color 0.3s; }
  button:hover { background-color: #005fa3; }
  select { background-color: white; color: black; border: 1px solid #ccc; }
  .back-btn { background-color: #888; }
  .back-btn:hover { background-color: #666; }
</style>
</head>
<body>
<div class="container">
  <!-- ページ1: 患者選択 -->
  <div id="page1">
    <h1>患者選択</h1>
    <select id="patientSelect"></select>
    <button onclick="goToPage('page2')">次へ</button>
  </div>

  <!-- ページ2: 手術室選択 -->
  <div id="page2" class="hidden">
    <h1>手術室選択</h1>
    <button onclick="goToPage('page3','OPE1')">OPE1</button>
    <button onclick="goToPage('page3','OPE2')">OPE2</button>
    <button onclick="goToPage('page3','OPE3')">OPE3</button>
    <button class="back-btn" onclick="goToPage('page1')">戻る</button>
  </div>

  <!-- ページ3: 項目選択 -->
  <div id="page3" class="hidden">
    <h1>項目選択</h1>
    <button onclick="goToPage('page4','予定時間延長')">予定時間延長</button>
    <button onclick="goToPage('page4','迎えまで15分')">迎えまで15分</button>
    <button onclick="goToPage('page4','IC場所')">IC場所</button>
    <button class="back-btn" onclick="goToPage('page2')">戻る</button>
  </div>

  <!-- ページ4: 詳細選択 -->
  <div id="page4" class="hidden">
    <h1>詳細選択</h1>
    <div id="detailButtons"></div>
    <button class="back-btn" onclick="goToPage('page3')">戻る</button>
  </div>
</div>

<script>
const SLACK_API = "/.netlify/functions/postToSlack";
const SHEET_API = "https://script.google.com/macros/s/AKfycbztqMATg9eZ2E7QJxH865wl1rqHjuuhc9vrL9WtR8afV9DZHgS5uhM8xJu8mYS7V-PI/exec";

let state = { patientName: '', patientCategory: '', ope: '', category: '', detail: '' };

// ページ切替
function goToPage(page, value='') {
  if(page==='page2'){
    const [name, category] = document.getElementById('patientSelect').value.split('|');
    state.patientName = name;
    state.patientCategory = category;
  } else if(page==='page3'){
    state.ope = value;
  } else if(page==='page4'){
    state.category = value;
    renderDetails(value);
  } else if(page==='send'){
    state.detail = value;
    sendMessage();
    return;
  }
  document.querySelectorAll('.container > div').forEach(d=>d.classList.add('hidden'));
  document.getElementById(page).classList.remove('hidden');
}

// 詳細ボタン生成
function renderDetails(category){
  const options = {
    '予定時間延長':['1時間以内','1時間以上','時間不明'],
    '迎えまで15分':['徒歩','車いす','ベッド'],
    'IC場所':['OPE カンファ室','病棟']
  };
  const container = document.getElementById('detailButtons');
  container.innerHTML = '';
  (options[category] || []).forEach(option=>{
    const btn = document.createElement('button');
    btn.innerText = option;
    btn.onclick = ()=>goToPage('send', option);
    container.appendChild(btn);
  });
}

// 患者リスト取得
async function fetchPatients(){
  try{
    const res = await fetch(SHEET_API+"?endpoint=patients");
    const data = await res.json();
    const select = document.getElementById('patientSelect');
    select.innerHTML='';
    if(data.ok && data.data.length){
      data.data.forEach(p=>{
        const opt = document.createElement('option');
        opt.value = `${p.name}|${p.category}`;
        opt.textContent = `${p.name} (${p.category})`;
        select.appendChild(opt);
      });
    } else {
      const opt = document.createElement('option');
      opt.textContent='患者データなし';
      select.appendChild(opt);
    }
  } catch(err){
    console.error("患者リスト取得エラー:",err);
  }
}

// データ送信（Slack & スプレッドシート）
async function sendMessage(){
  try{
    // Slack送信
    const slackRes = await fetch(SLACK_API,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ text:`${state.patientName} ${state.ope} ${state.category} ${state.detail}` })
    });
    const slackData = await slackRes.json();
    if(!slackData.ok){ alert("Slack送信エラー"); return; }

    // スプレッドシート送信
    const sheetRes = await fetch(SHEET_API,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(state)
    });
    const sheetData = await sheetRes.json();
    alert(sheetData.ok ? "送信成功！" : "スプレッドシート送信エラー");
  } catch(e){
    alert("通信エラー:"+e.message);
  }
  reset();
}

// 初期化
function reset(){
  state={patientName:'',patientCategory:'',ope:'',category:'',detail:''};
  goToPage('page1');
  fetchPatients();
}

// 起動時処理
window.onload = ()=>{
  reset();
  setInterval(fetchPatients,60000);
};
</script>
</body>
</html>
